name: æ¯æ—¥æ¸¯è‚¡æ ‡çš„è¿½è¸ª

on:
  schedule:
    # é¦™æ¸¯æ—¶é—´ 16:30ï¼ˆæ”¶ç›˜åï¼‰= UTC 08:30
    - cron: '30 8 * * 1-5'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  track-stocks:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas matplotlib
        
    - name: è¿è¡Œè¿½è¸ªè„šæœ¬
      run: |
        cd 07-æ ‡çš„è¿½è¸ª
        python auto_stock_tracker.py
        
    - name: æäº¤è¿½è¸ªæ•°æ®
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add 07-æ ‡çš„è¿½è¸ª/stock_data/
        git commit -m "ğŸ“Š æ›´æ–°æ¯æ—¥è¿½è¸ªæ•°æ® $(date +'%Y-%m-%d')" || echo "No changes to commit"
        git push
        
    - name: ä¸Šä¼ æŠ¥å‘Šä¸ºArtifact
      uses: actions/upload-artifact@v3
      with:
        name: daily-report-${{ github.run_date }}
        path: 07-æ ‡çš„è¿½è¸ª/stock_data/daily_report.md
        
    - name: åˆ›å»ºIssueæé†’ï¼ˆå¦‚æœ‰å¯ä¹°æ ‡çš„ï¼‰
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportPath = '07-æ ‡çš„è¿½è¸ª/stock_data/daily_report.md';
          
          if (fs.existsSync(reportPath)) {
            const report = fs.readFileSync(reportPath, 'utf8');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¹°å…¥æé†’
            if (report.includes('ğŸ”´ **å¯ä¹°**')) {
              // æå–å¯ä¹°æ ‡çš„
              const buySection = report.split('## ğŸ”” ä¹°å…¥æé†’')[1];
              const title = `ğŸš¨ ä¹°å…¥æé†’ - ${new Date().toISOString().split('T')[0]}`;
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: report,
                labels: ['buy-signal', 'automated']
              });
            }
          }
